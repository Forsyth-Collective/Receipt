<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receipt Generator</title>

  <!-- External libs (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-2:#0ea5a4;
      --radius:14px;
      --shadow: 0 8px 30px rgba(34,41,47,0.06);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#eef2ff);padding:24px;color:#0f172a}
    .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid rgba(15,23,42,0.04)}
    header{grid-column:1/-1;margin-bottom:4px}
    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px}

    /* Form layout */
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .full{grid-column:1/-1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], select, textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08);background:#fbfdff;font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    .segmented{display:flex;background:#f3f4f6;border-radius:10px;overflow:hidden}
    .segmented button{flex:1;padding:8px 12px;border:0;background:transparent;cursor:pointer;font-weight:600}
    .segmented button.active{background:linear-gradient(90deg,var(--accent),#4f46e5);color:white}

    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}

    /* thumbnails */
    .thumb-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumb{position:relative;width:88px;height:68px;border-radius:8px;overflow:hidden;border:1px solid rgba(15,23,42,0.06)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb button{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);border:0;color:white;border-radius:6px;padding:3px 6px;cursor:pointer;font-size:12px}

    .section-title{font-weight:700;margin:6px 0 10px}
    .calc{background:#f8fafc;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.03);display:flex;gap:12px;flex-direction:column}
    .calc .line{display:flex;justify-content:space-between;font-size:14px}
    .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    button.primary{background:var(--accent);border:0;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    button.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:8px 10px;border-radius:8px;cursor:pointer}

    /* receipt preview */
    .preview{overflow:auto}
    .receipt{width:100%;background:white;border-radius:10px;padding:14px;border:1px solid rgba(15,23,42,0.03)}
    .two-col{display:flex;gap:12px}
    .sig-canvas{border:1px dashed rgba(15,23,42,0.06);height:120px;border-radius:8px;width:100%}
    .sig-actions{display:flex;gap:8px;justify-content:center;margin-top:6px}
    .small{font-size:13px;color:var(--muted)}

    /* responsive */
    @media (max-width: 980px){
      .container{grid-template-columns:1fr; padding-bottom:60px}
      .form-grid{grid-template-columns:repeat(1,1fr)}
    }
  </style>
</head>
<body>

  <div class="container">
    <header class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:16px">
        <div>
          <h1>Receipt Generator</h1>
          <div class="subtitle">Fill seller/buyer info, choose Item or Service, attach images, capture signatures and export as PDF.</div>
        </div>
        <div class="small">Client-side only ‚Ä¢ No server required</div>
      </div>
    </header>

    <!-- LEFT: Form -->
    <main class="card" id="left">
      <form id="mainForm" onsubmit="return false;">
        <div class="form-grid">
          <!-- Seller -->
          <div>
            <div class="section-title">Seller Information</div>
            <label>First name<input type="text" id="seller_first" placeholder="John"></label>
            <label>Last name<input type="text" id="seller_last" placeholder="Doe"></label>
            <label>Property number / name<input type="text" id="seller_prop"></label>
            <label>Company (if applicable)<input type="text" id="seller_company"></label>
            <label>Address line 1<input type="text" id="seller_addr1"></label>
            <label>Address line 2<input type="text" id="seller_addr2"></label>
            <label>Address line 3<input type="text" id="seller_addr3"></label>
            <label>Town<input type="text" id="seller_town"></label>
            <label>County<input type="text" id="seller_county"></label>
            <label>Post code<input type="text" id="seller_post"></label>
            <label>Country<input type="text" id="seller_country"></label>
            <label>Telephone<input type="tel" id="seller_tel"></label>
            <label>Email<input type="email" id="seller_email"></label>
          </div>

          <!-- Buyer -->
          <div>
            <div class="section-title">Buyer Information</div>
            <label>First name<input type="text" id="buyer_first" placeholder="Jane"></label>
            <label>Last name<input type="text" id="buyer_last" placeholder="Smith"></label>
            <label>Property number / name<input type="text" id="buyer_prop"></label>
            <label>Company (if applicable)<input type="text" id="buyer_company"></label>
            <label>Address line 1<input type="text" id="buyer_addr1"></label>
            <label>Address line 2<input type="text" id="buyer_addr2"></label>
            <label>Address line 3<input type="text" id="buyer_addr3"></label>
            <label>Town<input type="text" id="buyer_town"></label>
            <label>County<input type="text" id="buyer_county"></label>
            <label>Post code<input type="text" id="buyer_post"></label>
            <label>Country<input type="text" id="buyer_country"></label>
            <label>Telephone<input type="tel" id="buyer_tel"></label>
            <label>Email<input type="email" id="buyer_email"></label>
          </div>

          <!-- Full row: purchase meta -->
          <div class="full">
            <div class="section-title">Purchase</div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <label style="flex:1">
                Online Purchased Site (e.g., Facebook)
                <input type="text" id="online_site" placeholder="Facebook Marketplace">
              </label>

              <div style="min-width:220px">
                <div class="muted">Select type</div>
                <div class="segmented" style="margin-top:6px">
                  <button id="btnItem" class="active" type="button">Item</button>
                  <button id="btnService" type="button">Service</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Item block -->
          <div id="itemBlock" class="full">
            <div class="section-title">Item Details</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <label>Item Name<input type="text" id="item_name"></label>
              <label>Condition<input type="text" id="item_condition" placeholder="New / Used"></label>
              <label class="full">Description<textarea id="item_desc"></textarea></label>
              <label>Item Cost (¬£)<input type="number" id="item_cost" step="0.01" value="0"></label>
              <label>Delivery Charge (¬£)<input type="number" id="item_delivery" step="0.01" value="0"></label>
              <div style="display:flex;flex-direction:column;gap:6px">
                <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="item_vat_reg"> VAT Registered</label>
                <input type="text" id="item_vat_num" placeholder="VAT number (if registered)" style="display:none">
                <div style="display:flex;gap:8px;align-items:center">
                  <select id="item_vat_rate" style="width:120px;display:none">
                    <option value="0">0%</option>
                    <option value="5">5%</option>
                    <option value="12.5">12.5%</option>
                    <option value="20" selected>20%</option>
                  </select>
                  <div class="muted" id="item_vat_amount">VAT to add: ¬£0.00</div>
                </div>
              </div>
            </div>

            <div style="display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap">
              <div>
                <label class="muted">Upload image(s)</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="item_image_input" type="file" accept="image/*" multiple>
                  <button id="item_image_add" class="ghost" type="button">Add</button>
                </div>
                <div class="thumb-grid" id="item_thumbs"></div>
              </div>

              <div style="margin-left:auto;min-width:220px">
                <div class="calc">
                  <div class="line"><div class="muted">Subtotal</div><div id="item_sub">¬£0.00</div></div>
                  <div class="line"><div class="muted">VAT</div><div id="item_vat">¬£0.00</div></div>
                  <div class="line" style="font-weight:700"><div>Total</div><div id="item_total">¬£0.00</div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Service block -->
          <div id="serviceBlock" class="full" style="display:none">
            <div class="section-title">Service Details</div>

            <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
              <label style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="service_vat_reg"> VAT Registered
              </label>
              <input type="text" id="service_vat_num" placeholder="VAT number" style="display:none">
              <select id="service_vat_rate" style="display:none">
                <option value="0">0%</option>
                <option value="5">5%</option>
                <option value="12.5">12.5%</option>
                <option value="20" selected>20%</option>
              </select>

              <label style="margin-left:auto">How many service items
                <select id="service_count">
                  <!-- 1..10 -->
                  <script>for(let i=1;i<=10;i++){document.write(`<option>${i}</option>`)};</script>
                </select>
              </label>
            </div>

            <div id="service_items" style="margin-top:12px;display:grid;gap:10px"></div>

            <div style="display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap">
              <div>
                <label class="muted">Upload image(s) of service</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input id="service_image_input" type="file" accept="image/*" multiple>
                  <button id="service_image_add" class="ghost" type="button">Add</button>
                </div>
                <div class="thumb-grid" id="service_thumbs"></div>
              </div>

              <div style="margin-left:auto;min-width:220px">
                <div class="calc">
                  <div class="line"><div class="muted">Sub total</div><div id="service_sub">¬£0.00</div></div>
                  <div class="line"><div class="muted">VAT</div><div id="service_vat">¬£0.00</div></div>
                  <div class="line" style="font-weight:700"><div>Total</div><div id="service_total">¬£0.00</div></div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- signatures -->
        <div style="margin-top:14px">
          <div class="section-title">Signatures</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="small">Seller Signature</div>
              <canvas id="sig_seller" class="sig-canvas"></canvas>
              <div class="sig-actions"><button id="seller_clear" class="ghost" type="button">Clear</button></div>
            </div>
            <div>
              <div class="small">Buyer Signature</div>
              <canvas id="sig_buyer" class="sig-canvas"></canvas>
              <div class="sig-actions"><button id="buyer_clear" class="ghost" type="button">Clear</button></div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
          <button id="previewButton" class="ghost" type="button">Refresh Preview</button>
          <button id="exportPDF" class="primary" type="button">Generate Receipt (PDF)</button>
        </div>

      </form>
    </main>

    <!-- RIGHT: Preview -->
    <aside class="card" id="right">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Receipt Preview</strong><div class="small">This is what will be exported to PDF.</div></div>
        <div class="small" id="generatedAt"></div>
      </div>

      <div style="margin-top:12px" class="preview">
        <div id="receipt" class="receipt">
          <!-- receipt contents built by JS -->
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
              <h3 style="margin:0">Receipt</h3>
              <div class="small" id="previewDate"></div>
            </div>
            <div style="text-align:right">
              <div class="small">Online site</div>
              <div id="previewOnline" style="font-weight:700"></div>
            </div>
          </div>

          <div style="margin-top:12px" class="two-col">
            <div style="flex:1">
              <div style="font-weight:700">Seller</div>
              <div id="p_seller_name"></div>
              <div id="p_seller_company" class="small"></div>
              <div id="p_seller_addr" class="small"></div>
              <div id="p_seller_contact" class="small"></div>
            </div>
            <div style="flex:1">
              <div style="font-weight:700">Buyer</div>
              <div id="p_buyer_name"></div>
              <div id="p_buyer_company" class="small"></div>
              <div id="p_buyer_addr" class="small"></div>
              <div id="p_buyer_contact" class="small"></div>
            </div>
          </div>

          <hr style="margin:12px 0">

          <div id="previewContent"></div>

          <div style="margin-top:12px" id="previewImages"></div>

          <div style="margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <div class="small">Seller Signature</div>
              <div id="p_sig_seller" style="border:1px solid rgba(15,23,42,0.04);height:80px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#fbfdff"></div>
            </div>
            <div>
              <div class="small">Buyer Signature</div>
              <div id="p_sig_buyer" style="border:1px solid rgba(15,23,42,0.04);height:80px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#fbfdff"></div>
            </div>
          </div>

        </div>
      </div>

    </aside>
  </div>

<script>
  // Utility
  const $ = (id) => document.getElementById(id);
  const money = (n) => '¬£' + Number(n || 0).toFixed(2);
  const nowStr = () => new Date().toLocaleString();

  // Mode toggle
  const btnItem = $('btnItem'), btnService = $('btnService'), itemBlock = $('itemBlock'), serviceBlock = $('serviceBlock');
  btnItem.addEventListener('click', () => { btnItem.classList.add('active'); btnService.classList.remove('active'); itemBlock.style.display='block'; serviceBlock.style.display='none'; updatePreview(); });
  btnService.addEventListener('click', () => { btnService.classList.add('active'); btnItem.classList.remove('active'); itemBlock.style.display='none'; serviceBlock.style.display='block'; updatePreview(); });

  // Signatures
  const sigSellerCanvas = $('sig_seller');
  const sigBuyerCanvas = $('sig_buyer');
  function fitCanvas(can){ can.width = can.clientWidth * devicePixelRatio; can.height = can.clientHeight * devicePixelRatio; const ctx=can.getContext('2d'); ctx.scale(devicePixelRatio, devicePixelRatio); }
  fitCanvas(sigSellerCanvas); fitCanvas(sigBuyerCanvas);
  const sigSeller = new SignaturePad(sigSellerCanvas, { penColor: "rgb(20,20,20)" });
  const sigBuyer = new SignaturePad(sigBuyerCanvas, { penColor: "rgb(20,20,20)" });
  window.addEventListener('resize', ()=>{ fitCanvas(sigSellerCanvas); fitCanvas(sigBuyerCanvas); sigSeller.clear(); sigBuyer.clear(); });

  $('seller_clear').addEventListener('click', ()=> sigSeller.clear());
  $('buyer_clear').addEventListener('click', ()=> sigBuyer.clear());

  // Item VAT controls
  const itemVatReg = $('item_vat_reg'), itemVatNum = $('item_vat_num'), itemVatRate = $('item_vat_rate');
  itemVatReg.addEventListener('change', ()=> {
    const on = itemVatReg.checked;
    itemVatNum.style.display = on ? 'block' : 'none';
    itemVatRate.style.display = on ? 'inline-block' : 'none';
    updateItemCalc();
    updatePreview();
  });

  // Service VAT controls
  const srvVatReg = $('service_vat_reg'), srvVatNum = $('service_vat_num'), srvVatRate = $('service_vat_rate');
  srvVatReg.addEventListener('change', ()=> {
    const on = srvVatReg.checked;
    srvVatNum.style.display = on ? 'inline-block' : 'none';
    srvVatRate.style.display = on ? 'inline-block' : 'none';
    updateServiceCalc();
    updatePreview();
  });

  // Item inputs
  ['item_cost','item_delivery','item_vat_rate'].forEach(id => $(id).addEventListener('input', ()=> { updateItemCalc(); updatePreview(); }));
  ['item_name','item_condition','item_desc'].forEach(id => $(id).addEventListener('input', updatePreview));

  function updateItemCalc(){
    const cost = parseFloat($('item_cost').value||0);
    const delivery = parseFloat($('item_delivery').value||0);
    const subtotal = cost + delivery;
    const vat = (itemVatReg.checked ? subtotal * (parseFloat(itemVatRate.value||0)/100) : 0);
    $('item_sub').textContent = money(subtotal);
    $('item_vat').textContent = money(vat);
    $('item_total').textContent = money(subtotal + vat);
    $('item_vat_amount').textContent = 'VAT to add: ' + money(vat);
  }

  // Service items dynamic
  const serviceCount = $('service_count'), serviceItemsDiv = $('service_items');
  function renderServiceItems(count){
    serviceItemsDiv.innerHTML = '';
    for(let i=0;i<count;i++){
      const idx = i;
      const block = document.createElement('div');
      block.style.border = '1px solid rgba(15,23,42,0.04)';
      block.style.padding = '10px';
      block.style.borderRadius = '8px';
      block.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Service item ${idx+1}</div>
          <div class="muted">Cost: <span id="svc_${idx}_cost_disp">¬£0.00</span></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 140px;gap:8px;margin-top:8px">
          <input id="svc_${idx}_name" placeholder="Service item name">
          <input id="svc_${idx}_cost" type="number" step="0.01" value="0">
        </div>
        <div style="margin-top:8px"><textarea id="svc_${idx}_desc" placeholder="Service description"></textarea></div>
      `;
      serviceItemsDiv.appendChild(block);

      // sync events
      $(`svc_${idx}_cost`).addEventListener('input', ()=> { $(`svc_${idx}_cost_disp`).textContent = money($(`svc_${idx}_cost`).value||0); updateServiceCalc(); updatePreview(); });
      $(`svc_${idx}_name`).addEventListener('input', updatePreview);
      $(`svc_${idx}_desc`).addEventListener('input', updatePreview);
    }
  }
  renderServiceItems(1);
  serviceCount.addEventListener('change', ()=> { renderServiceItems(parseInt(serviceCount.value)); updateServiceCalc(); updatePreview(); });

  function updateServiceCalc(){
    let subtotal = 0;
    const count = parseInt(serviceCount.value);
    for(let i=0;i<count;i++){
      const cost = parseFloat($(`svc_${i}_cost`).value||0);
      subtotal += cost;
    }
    const vat = srvVatReg.checked ? subtotal * (parseFloat(srvVatRate.value||0)/100) : 0;
    $('service_sub').textContent = money(subtotal);
    $('service_vat').textContent = money(vat);
    $('service_total').textContent = money(subtotal + vat);
  }

  // Images: add, preview, delete
  function setupImageControls(inputId, addButtonId, thumbContainerId, storeArray){
    const input = $(inputId), addBtn = $(addButtonId), container = $(thumbContainerId);
    // storeArray is an array reference to hold {id, file, url}
    addBtn.addEventListener('click', ()=> {
      // if user selected files, add them; otherwise trigger file picker
      if(input.files && input.files.length>0){
        addFiles(input.files);
        input.value = '';
      } else {
        input.click();
      }
    });
    input.addEventListener('change', ()=> {
      if(input.files && input.files.length>0){ addFiles(input.files); input.value=''; }
    });

    function addFiles(files){
      Array.from(files).forEach(f=>{
        if(!f.type.startsWith('image/')) return;
        const id = 'img_' + Math.random().toString(36).slice(2,9);
        const url = URL.createObjectURL(f);
        storeArray.push({id, file:f, url});
        const thumb = document.createElement('div'); thumb.className='thumb'; thumb.dataset.id=id;
        thumb.innerHTML = `<img src="${url}" alt=""><button title="Delete">üóëÔ∏è</button>`;
        container.appendChild(thumb);
        thumb.querySelector('button').addEventListener('click', ()=> {
          // remove
          const idx = storeArray.findIndex(x=>x.id===id);
          if(idx>=0) storeArray.splice(idx,1);
          URL.revokeObjectURL(url);
          thumb.remove();
          updatePreview();
        });
      });
      updatePreview();
    }
  }

  const itemImages = [], serviceImages = [];
  setupImageControls('item_image_input','item_image_add','item_thumbs', itemImages);
  setupImageControls('service_image_input','service_image_add','service_thumbs', serviceImages);

  // Preview builder
  function updatePreview(){
    // meta
    $('generatedAt').textContent = '';
    $('previewDate').textContent = nowStr();
    $('previewOnline').textContent = $('online_site').value || '';

    // seller
    const seller_name = `${$('seller_first').value||''} ${$('seller_last').value||''}`.trim();
    $('p_seller_name').textContent = seller_name;
    $('p_seller_company').textContent = $('seller_company').value || '';
    $('p_seller_addr').textContent = [ $('seller_prop').value, $('seller_addr1').value, $('seller_addr2').value, $('seller_addr3').value, $('seller_town').value, $('seller_county').value, $('seller_post').value, $('seller_country').value].filter(Boolean).join(', ');
    $('p_seller_contact').textContent = ['Tel: '+($('seller_tel').value||''), $('seller_email').value || ''].filter(Boolean).join(' ‚Ä¢ ');

    // buyer
    const buyer_name = `${$('buyer_first').value||''} ${$('buyer_last').value||''}`.trim();
    $('p_buyer_name').textContent = buyer_name;
    $('p_buyer_company').textContent = $('buyer_company').value || '';
    $('p_buyer_addr').textContent = [ $('buyer_prop').value, $('buyer_addr1').value, $('buyer_addr2').value, $('buyer_addr3').value, $('buyer_town').value, $('buyer_county').value, $('buyer_post').value, $('buyer_country').value].filter(Boolean).join(', ');
    $('p_buyer_contact').textContent = ['Tel: '+($('buyer_tel').value||''), $('buyer_email').value || ''].filter(Boolean).join(' ‚Ä¢ ');

    // content area
    const previewContent = $('previewContent');
    previewContent.innerHTML = '';
    if(btnItem.classList.contains('active')){
      updateItemCalc();
      const name = $('item_name').value || '‚Äî';
      const desc = $('item_desc').value || '';
      const cond = $('item_condition').value || '';
      const cost = parseFloat($('item_cost').value||0);
      const delivery = parseFloat($('item_delivery').value||0);
      const subtotal = cost + delivery;
      const vat = (itemVatReg.checked ? subtotal * (parseFloat(itemVatRate.value||0)/100) : 0);

      previewContent.innerHTML = `
        <div style="font-weight:700">Item</div>
        <div style="margin-top:6px"><strong>${escapeHtml(name)}</strong> ${cond ? '‚Ä¢ ' + escapeHtml(cond): ''}</div>
        <div class="small">${escapeHtml(desc)}</div>
        <div style="margin-top:8px">
          <div style="display:flex;justify-content:space-between"><div class="small">Cost</div><div>${money(cost)}</div></div>
          <div style="display:flex;justify-content:space-between"><div class="small">Delivery</div><div>${money(delivery)}</div></div>
          <div style="display:flex;justify-content:space-between"><div class="small">VAT</div><div>${money(vat)}</div></div>
          <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:6px"><div>Total</div><div>${money(subtotal + vat)}</div></div>
        </div>
      `;
    } else {
      // service
      updateServiceCalc();
      const count = parseInt(serviceCount.value);
      let html = `<div style="font-weight:700">Service</div>`;
      for(let i=0;i<count;i++){
        const name = $(`svc_${i}_name`).value || `Service ${i+1}`;
        const desc = $(`svc_${i}_desc`).value || '';
        const cost = parseFloat($(`svc_${i}_cost`).value||0);
        html += `<div style="margin-top:8px"><strong>${escapeHtml(name)}</strong> ‚Äî <span class="small">${escapeHtml(desc)}</span>
                 <div style="display:flex;justify-content:space-between"><div class="small">Cost</div><div>${money(cost)}</div></div></div>`;
      }
      const subtotal = parseFloat($('service_sub').textContent.replace('¬£','')) || 0;
      const vat = parseFloat($('service_vat').textContent.replace('¬£','')) || 0;
      html += `<div style="margin-top:10px">
                <div style="display:flex;justify-content:space-between"><div class="small">Sub total</div><div>${money(subtotal)}</div></div>
                <div style="display:flex;justify-content:space-between"><div class="small">VAT</div><div>${money(vat)}</div></div>
                <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:6px"><div>Total</div><div>${money(subtotal + vat)}</div></div>
               </div>`;
      previewContent.innerHTML = html;
    }

    // images (combined from itemImages or serviceImages depending on mode)
    const previewImages = $('previewImages');
    previewImages.innerHTML = '';
    const imgs = (btnItem.classList.contains('active') ? itemImages : serviceImages);
    if(imgs.length){
      const cont = document.createElement('div');
      cont.style.display='flex'; cont.style.gap='8px'; cont.style.flexWrap='wrap'; cont.style.marginTop='8px';
      imgs.forEach(obj=>{
        const el = document.createElement('img'); el.src = obj.url; el.style.width='120px'; el.style.height='90px'; el.style.objectFit='cover'; el.style.borderRadius='6px'; el.style.border='1px solid rgba(15,23,42,0.04)';
        cont.appendChild(el);
      });
      previewImages.appendChild(cont);
    }

    // signatures preview (use dataURL if present)
    const p_sig_seller = $('p_sig_seller'), p_sig_buyer = $('p_sig_buyer');
    p_sig_seller.innerHTML = ''; p_sig_buyer.innerHTML = '';
    if(!sigSeller.isEmpty()){
      const img = document.createElement('img'); img.src = sigSeller.toDataURL('image/png'); img.style.maxHeight='80px'; img.style.maxWidth='100%'; p_sig_seller.appendChild(img);
    } else { p_sig_seller.innerHTML = '<div class="small">Not signed</div>'; }
    if(!sigBuyer.isEmpty()){
      const img = document.createElement('img'); img.src = sigBuyer.toDataURL('image/png'); img.style.maxHeight='80px'; img.style.maxWidth='100%'; p_sig_buyer.appendChild(img);
    } else { p_sig_buyer.innerHTML = '<div class="small">Not signed</div>'; }

    $('generatedAt').textContent = ''; // we'll show on export
  }

  // Escape HTML helper
  function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // Initial preview
  updatePreview();

  // Preview refresh button
  $('previewButton').addEventListener('click', updatePreview);

  // Export to PDF
  $('exportPDF').addEventListener('click', async function(){
    updatePreview();

    // Insert current timestamp into preview header
    $('generatedAt').textContent = 'Generated: ' + nowStr();

    const receiptEl = $('receipt');

    // we want high quality: scale
    const scale = 2;
    const originalWidth = receiptEl.offsetWidth;
    const originalHeight = receiptEl.offsetHeight;

    // temporarily set background white to avoid transparency issues
    receiptEl.style.background = 'white';

    try {
      const canvas = await html2canvas(receiptEl, {
        scale: scale,
        useCORS: true,
        allowTaint: true,
        logging: false,
        windowWidth: document.documentElement.clientWidth,
        windowHeight: document.documentElement.clientHeight
      });

      // create PDF with proper page break scaling (A4 portrait)
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgData = canvas.toDataURL('image/png');
      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth - 20; // 10mm margin each side
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

      let position = 10;
      pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      // if the content is taller than one A4, add pages (split by height)
      if(imgHeight > pageHeight - 20){
        // number of pages
        const totalPages = Math.ceil(imgHeight / (pageHeight - 20));
        for(let i=1;i<totalPages;i++){
          pdf.addPage();
          const y = -(pageHeight - 20) * i + 10;
          pdf.addImage(imgData, 'PNG', 10, y, imgWidth, imgHeight);
        }
      }

      const filename = `receipt_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
      pdf.save(filename);
    } catch (err){
      alert('Error generating PDF: ' + err.message);
      console.error(err);
    } finally {
      receiptEl.style.background = ''; // reset
    }
  });

  // Keep preview up-to-date on many inputs
  const inputsToWatch = Array.from(document.querySelectorAll('input, textarea, select'));
  inputsToWatch.forEach(el => el.addEventListener('input', ()=> {
    // debounce slightly to avoid too many updates
    clearTimeout(el._t); el._t = setTimeout(updatePreview, 120);
  }));

  // ensure service calc updates when vat rate changes
  $('service_vat_rate').addEventListener('input', updateServiceCalc);
  // also update item calc if VAT rate changes
  $('item_vat_rate').addEventListener('input', updateItemCalc);

  // Initial small calc fills
  updateItemCalc();
  updateServiceCalc();

</script>
</body>
</html>
